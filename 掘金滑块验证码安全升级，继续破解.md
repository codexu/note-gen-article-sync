# æ˜é‡‘æ»‘å—éªŒè¯ç å®‰å…¨å‡çº§ï¼Œç»§ç»­ç ´è§£

å»å¹´å‘è¿‡ä¸€ç¯‡æ–‡ç« ï¼Œ[ã€Šä½¿ç”¨å‰ç«¯æŠ€æœ¯ç ´è§£æ˜é‡‘æ»‘å—éªŒè¯ç ã€‹](https://juejin.cn/post/7257386139849801789)ï¼Œæˆ‘å¾ˆä½©æœæ˜é‡‘å®˜æ–¹çš„æ°”åº¦ï¼Œä¸ä½†å…è®¸æˆ‘å‘å¸ƒè¿™ç¯‡æ–‡ç« ï¼Œè¿˜åŒæ­¥å‘åˆ°äº†å®˜æ–¹å…¬ä¼—å·ã€‚æœ€è¿‘å‘ç°æ˜é‡‘çš„æ»‘å—éªŒè¯ç å‡çº§äº†ï¼Œä¹Ÿè®¸æ˜¯æˆ‘é‚£ç¯‡æ–‡ç« èµ·åˆ°äº†ä¸€äº›ä½œç”¨ï¼Œé€¼è¿«å®˜æ–¹åŠ å¼ºäº†å®‰å…¨æ€§ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ç°è±¡ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/381c0d98cd054057a48a46f4093bc368~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=876\&h=354\&s=60934\&e=png\&b=191919)

ä¸è¿‡ï¼Œè¿™å¹¶ä¸æ˜¯ç»ˆç‚¹ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥ç»§ç»­ç ´è§£ã€‚éªŒè¯ç çš„å®‰å…¨æ€§æ˜¯åœ¨ç”¨æˆ·ä½“éªŒå’Œå®‰å…¨æ€§ä¹‹é—´çš„ä¸€ä¸ªå¹³è¡¡ï¼Œå¦‚æœå®‰å…¨æ€§å¤ªé«˜ï¼Œç”¨æˆ·ä½“éªŒå°±ä¼šå˜å·®ï¼Œå¦‚æœç”¨æˆ·ä½“éªŒå¤ªå¥½ï¼Œå®‰å…¨æ€§å°±ä¼šå˜å·®ã€‚æ˜é‡‘çš„æ»‘å—éªŒè¯ç æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œå®ƒçš„å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒä¹‹é—´çš„å¹³è¡¡åšå¾—éå¸¸å¥½ï¼Œå¹¶ä¸”æˆ‘ä»¬ç ´è§£çš„éš¾åº¦ä½“éªŒä¹Ÿéå¸¸å¥½ã€‚ ğŸ˜„

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6f8ff95630284f9e9cf9c9fd2201a309~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=652\&h=432\&s=287553\&e=gif\&f=51\&b=050505)

## æœ¬æ¬¡å‡çº§çš„å†…å®¹

æ˜é‡‘çš„æ»‘å—éªŒè¯ç å‡çº§äº†ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹é¢çš„æ”¹è¿›ï¼š

1.  é¦–å…ˆéªŒè¯ç ä¸å†æ˜¯æ˜é‡‘è‡ªå·±çš„éªŒè¯ç äº†ï¼Œè€Œæ˜¯ä½¿ç”¨äº†å­—èŠ‚çš„æ ¡éªŒæœåŠ¡ï¼Œå¯ä»¥çœ‹åˆ°å¼¹çª—æ˜¯ä¸€ä¸ª iframeï¼Œå¹¶ä¸”åŸŸåæ˜¯ `bytedance.com`ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e9e93ef463854fa59be6d6539ab19473~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1122\&h=344\&s=81883\&e=png\&b=282828)

> æˆ‘ä»¬éƒ½çŸ¥é“æ˜é‡‘è¢«å­—èŠ‚æ”¶è´­äº†ï¼Œå¯ä»¥çŒœæµ‹éªŒè¯ç çš„å‡çº§æ˜¯å­—èŠ‚è·³åŠ¨çš„å›¢é˜Ÿåšçš„ã€‚

2.  éªŒè¯ç çš„å›¾å½¢ä¸å†æ˜¯æ‹¼å›¾ï¼Œè€Œæ˜¯éšæœºçš„ä¸åŒå½¢çŠ¶ï¼Œæ¯”å¦‚çˆ±å¿ƒã€å…­è§’æ˜Ÿã€åœ†ç¯ã€æœˆäº®ã€ç›¾ç‰Œç­‰ã€‚
3.  å¢åŠ äº†å¹²æ‰°ç¼ºå£ï¼Œä¸»è¦æ˜¯å¤§å°æˆ–æ—‹è½¬è¿™ç§æ“ä½œã€‚

ä¸‹é¢çœ‹ä¸€ä¸‹æ”¹ç‰ˆåçš„æ»‘å—éªŒè¯ç ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb30892758b74142a482616267345a94~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=674\&h=422\&s=408343\&e=png\&b=7b9fd5)

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a0aecd5ff7db43d6883e050d90dd5094~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=678\&h=424\&s=337875\&e=png\&b=436688)

æˆ‘åœ¨æ–‡ç« çš„è¯„è®ºåŒºçœ‹åˆ°äº†ä¸€äº›å…³äºè¿™æ¬¡å‡çº§æˆ–ç›¸å…³çš„è®¨è®ºï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0630316361c54e029581f78590b69a1e~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1166\&h=460\&s=107024\&e=png\&b=181818)

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e3a717604d9949798495e3dd6dcaf0d9~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1076\&h=224\&s=39450\&e=png\&b=191919)

æœ¬æ–‡å°†ç»§ç»­ç ´è§£è¿™æ¬¡å‡çº§åçš„æ»‘å—éªŒè¯ç ï¼Œçœ‹çœ‹è¿™æ¬¡å‡çº§å¯¹ç ´è§£çš„éš¾åº¦æœ‰å¤šå¤§å½±å“ï¼Œå¦‚æœä½ è¿˜æ²¡æœ‰äº†è§£è¿‡å¦‚ä½•ç ´è§£æ»‘å—éªŒè¯ç ï¼Œè¯·å…ˆçœ‹æˆ‘ä¹‹å‰çš„æ–‡ç« ã€‚

## iframe

è¿™æ¬¡å‡çº§ï¼Œæ•´ä¸ªæ»‘å—éƒ½æ‰ç”¨çš„æ˜¯å¤–éƒ¨é“¾æ¥ï¼Œä½¿ç”¨ iframe å‘ˆç°ï¼Œé‚£ä¹ˆåœ¨ puppeteer ä¸­å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ

```ts
await page.waitForSelector('iframe');
const elementHandle = await page.$('iframe');
const frame = await elementHandle.contentFrame();
```

å®é™…ä¸Šï¼Œæˆ‘ä»¬åªéœ€è¦ç­‰å¾… iframe åŠ è½½å®Œæˆï¼Œç„¶åè·å– iframe çš„å†…å®¹å³å¯ã€‚

Frame å¯¹è±¡å’Œ Page å¯¹è±¡æœ‰å¾ˆå¤šç›¸ä¼¼çš„æ–¹æ³•ï¼Œæ¯”å¦‚ `frame.$`ã€`frame.evaluate` ç­‰ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›æ–¹æ³•æ¥æ“ä½œ iframe ä¸­çš„å…ƒç´ ã€‚

## éªŒè¯ç çš„è¯†åˆ«

ä¸Šä¸€ç¯‡æ–‡ç« é‡‡ç”¨æ¯”è¾ƒç®€å•çš„åˆ¤æ–­æ–¹å¼ï¼Œå½“æ—¶ç¼ºå£å¤„æœ‰æ˜æ˜¾çš„ç™½è¾¹ï¼Œæ‰€ä»¥åªéœ€è¦æ‰¾åˆ°è¿™ä¸ªç™½è¾¹å³å¯ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9f2df166e3074e5697a5a22657d7cd5c~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=852\&h=792\&s=563802\&e=png\&b=f4edea)

ä½†æ˜¯æœ¬æ¬¡å‡çº§åï¼Œç¼ºå£ä¸å†æ˜¯ç™½è¾¹ï¼Œè€Œæ˜¯é˜´å½±çš„æ•ˆæœï¼Œå¹¶ä¸”ç¼ºå£çš„å½¢çŠ¶ä¹Ÿä¸å†æ˜¯æ‹¼å›¾ï¼Œå¤§æ¦‚ç‡éƒ½æ˜¯æ›²çº¿çš„è¾¹ï¼Œæ‰€ä»¥å†åˆ¤æ–­ç¼ºå£çš„æ–¹å¼å°±ä¸å†é€‚ç”¨äº†ã€‚

ç°åœ¨æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸€ç§æ–°çš„æ–¹å¼ï¼Œé€šè¿‡å¯¹æ¯”æ»‘å—å›¾ç‰‡å’Œç¼ºå£åŒºåŸŸçš„åƒç´ å€¼ç›¸ä¼¼ç¨‹åº¦æ¥åˆ¤æ–­ç¼ºå£ä½ç½®ã€‚

é¦–å…ˆè¿˜æ˜¯äºŒå€¼åŒ–å¤„ç†ï¼Œå°†å›¾ç‰‡è½¬æ¢ä¸ºé»‘ç™½ä¸¤è‰²ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c31eb4730ab14d63a52f954ee29f6b21~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=676\&h=418\&s=63717\&e=png\&b=fbfafa)

å¯ä»¥çœ‹åˆ°å·¦ä¾§ç¼ºå£å’Œå³ä¾§ç¼ºå£éå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯åšäº†ä¸€ç‚¹æ—‹è½¬ä½œä¸ºå¹²æ‰°ã€‚

å†çœ‹ä¸€ä¸‹ï¼Œiframe ä¸­è¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ä¸œè¥¿ï¼Œå°±æ˜¯æ ¡éªŒçš„å›¾ç‰‡ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e21b03f2e5524813a23daa8b80313486~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=110\&h=110\&s=28655\&e=png\&a=1\&b=f2c190)
![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/873aa36e732e4b18afe6dab7f6f72a08~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=552\&h=344\&s=18977\&e=jpg\&b=fdd5a0)

å®ƒæ˜¯ä¸€ä¸ª png å›¾ç‰‡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠå®ƒä¹Ÿè½¬æ¢æˆäºŒå€¼åŒ–ï¼Œç®€å•çš„æ–¹å¼å°±æ˜¯å°†é€æ˜è‰²è½¬æ¢ä¸ºç™½è‰²ï¼Œéé€æ˜è‰²è½¬æ¢ä¸ºé»‘è‰²ï¼Œå¦‚æœæƒ³æé«˜è¯†åˆ«ç²¾åº¦ï¼Œå¯ä»¥ä¸èƒŒæ™¯å›¾ä¸€æ ·ï¼Œé€šè¿‡ç°åº¦ã€äºŒå€¼åŒ–çš„è½¬æ¢æ–¹å¼ã€‚

```ts
// è·å–ç¼ºå£å›¾åƒ
const captchaVerifyImage = document.querySelector(
  '#captcha-verify_img_slide',
) as HTMLImageElement;
// åˆ›å»ºä¸€ä¸ªç”»å¸ƒï¼Œå°† image è½¬æ¢æˆcanvas
const captchaCanvas = document.createElement('canvas');
captchaCanvas.width = captchaVerifyImage.width;
captchaCanvas.height = captchaVerifyImage.height;
const captchaCtx = captchaCanvas.getContext('2d');
captchaCtx.drawImage(
  captchaVerifyImage,
  0,
  0,
  captchaVerifyImage.width,
  captchaVerifyImage.height,
);
const captchaImageData = captchaCtx.getImageData(
  0,
  0,
  captchaVerifyImage.width,
  captchaVerifyImage.height,
);
// å°†åƒç´ æ•°æ®è½¬æ¢ä¸ºäºŒç»´æ•°ç»„ï¼ŒåŒæ ·å¤„ç†ç°åº¦ã€äºŒå€¼åŒ–ï¼Œå°†åƒç´ ç‚¹è½¬æ¢ä¸º0ï¼ˆé»‘è‰²ï¼‰æˆ–1ï¼ˆç™½è‰²ï¼‰
const captchaData: number[][] = [];
for (let h = 0; h < captchaVerifyImage.height; h++) {
  captchaData.push([]);
  for (let w = 0; w < captchaVerifyImage.width; w++) {
    const index = (h * captchaVerifyImage.width + w) * 4;
    const r = captchaImageData.data[index] * 0.2126;
    const g = captchaImageData.data[index + 1] * 0.7152;
    const b = captchaImageData.data[index + 2] * 0.0722;
    if (r + g + b > 30) {
      captchaData[h].push(0);
    } else {
      captchaData[h].push(1);
    }
  }
}
```

ä¸ºäº†å¯¹æ¯”å›¾å½¢çš„ç›¸ä¼¼åº¦ï¼ŒäºŒå€¼åŒ–åçš„æ•°æ®æˆ‘ä»¬é¡µé‡‡ç”¨äºŒç»´æ•°ç»„çš„æ–¹å¼å­˜å‚¨ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿çš„å¯¹æ¯”ä¸¤ä¸ªå›¾å½¢çš„ç›¸ä¼¼åº¦ã€‚

å¦‚æœæƒ³è§‚æµ‹äºŒå€¼åŒ–åçš„çœŸæ˜¯æ•ˆæœï¼Œå¯ä»¥æŠŠäºŒä½æ•°ç»„è½¬æ¢ä¸ºé¢œè‰²ï¼Œå¹¶è¦†ç›–åˆ°åŸå›¾ä¸Šï¼š

```ts
// é€šè¿‡ captchaData 0 é»‘è‰² æˆ– 1 ç™½è‰² çš„å€¼ï¼Œç»˜åˆ¶åˆ° canvas ä¸Šï¼ŒæŸ¥çœ‹æ•ˆæœ
for (let h = 0; h < captchaVerifyImage.height; h++) {
  for (let w = 0; w < captchaVerifyImage.width; w++) {
    captchaCtx.fillStyle =
      captchaData[h][w] == 1 ? 'rgba(0,0,0,0)' : 'black';
    captchaCtx.fillRect(w, h, 1, 1);
  }
}
captchaVerifyImage.src = captchaCanvas.toDataURL();
```

æ•°æ®æ‹¿åˆ°åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹å¯¹æ¯”ä¸¤ä¸ªå›¾å½¢çš„ç›¸ä¼¼åº¦ï¼Œè¿™é‡Œå°±é‡‡ç”¨éå¸¸ç®€å•çš„å¯¹æ¯”æ–¹å¼ï¼Œä»å·¦å‘å³ï¼Œé€ä¸ªåƒç´ ç‚¹å¯¹æ¯”ï¼Œæ¨ªå‘æ¯ä¸ªå›¾å½¢çš„åƒç´ ä¸€è‡´çš„ç‚¹æ•°é‡çºªå½•ä¸‹æ¥ï¼Œç„¶åå–æœ€å¤§å€¼ï¼Œè¿™ä¸ªæœ€å¤§å€¼å°±æ˜¯ç¼ºå£çš„ä½ç½®ã€‚

è¿™é‡Œæˆ‘ä»¬å…ˆä¼˜åŒ–ä¸€ä¸‹è¦å¯¹æ¯”çš„æ•°æ®ï¼Œæˆ‘ä»¬åªéœ€è¦å¯¹æ¯”ç¼ºå£çš„é¡¶éƒ¨åˆ°åº•éƒ¨è¿™æ®µçš„æ•°æ®ï¼Œæˆªå–è¿™ä¸€æ®µï¼Œå¯ä»¥å‡å°‘å¯¹æ¯”çš„æ€§èƒ½æ¶ˆè€—ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/96c496a3215f465c972503ecfc544d2e~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1344\&h=818\&s=77218\&e=png\&b=faf9f9)

```ts
// è·å–captchaVerifyImage ç›¸å¯¹äº .verify-image çš„åç§»é‡
const captchaVerifyImageBox = captchaVerifyImage.getBoundingClientRect();
const captchaVerifyImageTop = captchaVerifyImageBox.top;
// è·å–ç¼ºå£å›¾åƒçš„ä½ç½®
const imageBox = image.getBoundingClientRect();
const imageTop = imageBox.top;
// è®¡ç®—ç¼ºå£å›¾åƒçš„ä½ç½®ï¼Œtop å‘ä¸Šå–æ•´ï¼Œbottom å‘ä¸‹å–æ•´
const top = Math.floor(captchaVerifyImageTop - imageTop);
// data æˆªå–ä» top åˆ—åˆ° top + image.height åˆ—çš„æ•°æ®
const sliceData = data.slice(top, top + image.height);
```

ç„¶åå¾ªç¯å¯¹æ¯”ä¸¤ä¸ªå›¾å½¢çš„åƒç´ ç‚¹ï¼Œè®¡ç®—ç›¸ä¼¼åº¦ï¼š

```ts
// å¾ªç¯å¯¹æ¯” captchaData å’Œ sliceDataï¼Œä»å·¦åˆ°å³ï¼Œæ¯æ¬¡å¢åŠ ä¸€åˆ—ï¼Œè¿”å›æ ¡éªŒç›¸åŒçš„æ•°é‡
const equalPoints = [];
// ä»å·¦åˆ°å³ï¼Œæ¯æ¬¡å¢åŠ ä¸€åˆ—
for (let leftIndex = 0; leftIndex < sliceData[0].length; leftIndex++) {
  let equalPoint = 0;
  // æ–°æ•°ç»„ sliceData æˆªå– leftIndex - leftIndex + captchaVerifyImage.width åˆ—çš„æ•°æ®
  const compareSliceData = sliceData.map((item) =>
    item.slice(leftIndex, leftIndex + captchaVerifyImage.width),
  );
  // å¾ªç¯åˆ¤æ–­ captchaData å’Œ compareSliceData ç›¸åŒå€¼çš„æ•°é‡
  for (let h = 0; h < captchaData.length; h++) {
    for (let w = 0; w < captchaData[h].length; w++) {
      if (captchaData[h][w] === compareSliceData[h][w]) {
        equalPoint++;
      }
    }
  }
  equalPoints.push(equalPoint);
}
// æ‰¾åˆ°æœ€å¤§çš„ç›¸åŒæ•°é‡ï¼Œå¤§æ¦‚ç‡ä¸ºç¼ºå£ä½ç½®
return equalPoints.indexOf(Math.max(...equalPoints));
```

å¯¹æ¯”æ—¶åƒç´ è¾ƒå¤šï¼Œä¸å®¹æ˜“ç›´æ¥çœ‹åˆ°æ•ˆæœï¼Œè¿™é‡Œå†™ä¸€ä¸ªç®€å•çš„äºŒä½æ•°ç»„å¯¹æ¯”ï¼Œæ–¹ä¾¿å„ä½ç†è§£ï¼š

    [
      [0, 1, 0],
      [1, 0, 1],
      [0, 1, 0],
    ]
    [
      [0, 0, 0, 1, 0, 0],
      [0, 0, 1, 0, 1, 0],
      [0, 0, 0, 1, 0, 0],
    ]

å¾ªç¯å¯¹æ¯”ï¼Œé‚£ä¹ˆç¬¬3åˆ—å¼€å§‹ï¼ŒåŒ¹é…çš„æ•°é‡å¯ä»¥è¾¾åˆ°9ï¼Œæ‰€ä»¥è¿”å› 3ï¼Œè¿™æ ·å°±æ˜¯æ»‘å—è¦ç§»åŠ¨çš„ä½ç½®ã€‚

å¹²æ‰°ç¼ºå£å…¶å®å¯¹æˆ‘ä»¬è¿™ä¸ªè¯†åˆ«æ–¹å¼æ²¡ä»€ä¹ˆå½±å“ï¼Œæœ€å¤šå¯èƒ½ä¼šå¢åŠ ä¸€äº›å¤±è´¥çš„æ¦‚ç‡ï¼Œæˆ‘ä¸ªäººæµ‹è¯•äº†ä¸€ä¸‹ï¼Œè¯†åˆ«æˆåŠŸç‡æœ‰ 95% å·¦å³ã€‚

## æ€»ç»“

è¿™æ¬¡å‡çº§åï¼Œæ˜é‡‘çš„æ»‘å—éªŒè¯ç çš„å®‰å…¨æ€§æœ‰äº†ä¸€å®šçš„æå‡ï¼Œè¿˜æ˜¯å¯ä»¥ç»§ç»­ç ´è§£çš„ï¼Œåªæ˜¯éš¾åº¦æœ‰æ‰€å¢åŠ ã€‚æœ€åå†å¥‰åŠå¤§å®¶ä¸è¦æ»¥ç”¨è¿™ä¸ªæŠ€èƒ½ï¼Œè¿™åªæ˜¯ä¸ºäº†å­¦ä¹ å’Œç ”ç©¶ï¼Œä¸è¦ç”¨äºéæ³•ç”¨é€”ã€‚å¦‚æœå„ä½è¹²å±€å­ï¼Œå¯ä¸å…³æˆ‘äº‹å•Šã€‚ ğŸ¤”ï¸
